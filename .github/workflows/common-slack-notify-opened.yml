name: Slack Notification (Opened/Ready)

on:
  pull_request:
    types: [ opened, ready_for_review ]

permissions: { }

concurrency:
  group: pr-${{ github.event.pull_request.number }}-slack-opened-ready
  cancel-in-progress: true

# ÏµúÏ¥à Î¶¨Î∑∞ ÏöîÏ≤≠ ÏïåÎ¶º
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # JSON ÌååÏã± ÎèÑÍµ¨
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Notify Initial Reviewers
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REVIEWERS_JSON: ${{ toJson(github.event.pull_request.requested_reviewers) }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          declare -A GITHUB_TO_SLACK
          GITHUB_TO_SLACK["soeun2537"]="U09A0LM0CRW"
          GITHUB_TO_SLACK["taek2222"]="U099ARRH3D3"
          GITHUB_TO_SLACK["changuii"]="U099BR9RNE6"
          GITHUB_TO_SLACK["eoehd1ek"]="U0995NANDML"
          GITHUB_TO_SLACK["oungsi2000"]="U098U2R57NK"
          GITHUB_TO_SLACK["parkjiminnnn"]="U098U8SLXHD"
          GITHUB_TO_SLACK["etama123"]="U0995MPSZ62"

          author_id=${GITHUB_TO_SLACK[$PR_AUTHOR]}
          if [[ -n "$author_id" ]]; then
            SLACK_AUTHOR_MENTION="<@$author_id>"
          else
            SLACK_AUTHOR_MENTION="@${PR_AUTHOR}"
          fi

          REVIEWER_MENTIONS=""
          for reviewer in $(echo "$REVIEWERS_JSON" | jq -r '.[].login'); do
            [[ "$reviewer" == *"[bot]" ]] && continue
            slack_id=${GITHUB_TO_SLACK[$reviewer]}
            [[ -z "$slack_id" ]] && continue
            REVIEWER_MENTIONS+="<@$slack_id> "
          done

          if [ -z "$REVIEWER_MENTIONS" ]; then
            echo "Î¶¨Î∑∞Ïñ¥Í∞Ä ÏóÜÏúºÎØÄÎ°ú ÏïåÎ¶º ÏÉùÎûµ"
            exit 0
          fi
          
          PAYLOAD=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg title "$PR_TITLE" \
            --arg number "$PR_NUMBER" \
            --arg author "$SLACK_AUTHOR_MENTION" \
            --arg reviewers "$REVIEWER_MENTIONS" \
            --arg url "$PR_URL" \
            '{
              text: "üî• (\($repo)) Î¶¨Î∑∞ ÏöîÏ≤≠ ÏïåÎ¶º",
              blocks: [
                {type: "header", text: {type: "plain_text", text: "üî• (\($repo)) Î¶¨Î∑∞ ÏöîÏ≤≠ ÏïåÎ¶º", emoji: true}},
                {type: "section", text: {type: "mrkdwn", text: "*PR Ï†úÎ™©:* \($title) (#\($number))\n*ÏûëÏÑ±Ïûê:* \($author)\n*Î¶¨Î∑∞Ïñ¥:* \($reviewers)\n*ÎßÅÌÅ¨:* \($url)"}}
              ]
            }')
          
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK_URL
