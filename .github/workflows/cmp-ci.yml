name: CMP CI

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**'

jobs:
  Run-PR-Test:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write

    steps:
      - name: Repository Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          # CMP ë£¨íŠ¸ì˜ íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ í•´ì‹œë¥¼ ìƒì„±í•˜ë„ë¡ ê²½ë¡œ ìˆ˜ì •
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle.kts', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create local.properties
        run: |
          # CMP ë¹Œë“œ ì‹œ BuildKonfigê°€ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ë£¨íŠ¸ì— ìƒì„±
          echo "BASE_URL=${{ secrets.BASE_URL }}" > local.properties
          echo "BASE_URL_DEV=${{ secrets.BASE_URL_DEV }}" >> local.properties
          echo "NAVER_MAP_CLIENT_ID=${{ secrets.NAVER_MAP_CLIENT_ID }}" >> local.properties
          echo "NAVER_MAP_STYLE_ID=${{ secrets.NAVER_MAP_STYLE_ID }}" >> local.properties

      - name: Load Google Service file
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: echo "$DATA" > composeApp/google-services.json

      - name: Restore keystore file
        run: |
          mkdir -p composeApp
          echo "$KEYSTORE_BASE64" | base64 --decode > ./composeApp/festabook_appkey.jks
          echo "JKS_FILE_PATH=./composeApp/festabook_appkey.jks" >> local.properties
          echo "STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}" >> local.properties
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> local.properties
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> local.properties
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Clean Project
        run: ./gradlew clean

      - name: Generate BuildKonfig
        # BuildKonfig ê°ì²´ë¥¼ ë¨¼ì € ìƒì„±í•´ì•¼ í…ŒìŠ¤íŠ¸ë‚˜ ë¹Œë“œê°€ ê°€ëŠ¥í•¨
        run: ./gradlew :composeApp:generateBuildKonfig

      - name: Run ktlint
        run: ./gradlew ktlintCheck

      - name: Run Unit Test
        # CMPì—ì„œëŠ” ëª¨ë“ˆë³„ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        run: ./gradlew :composeApp:test

      - name: Publish Unit Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          # ê²°ê³¼ ë¦¬í¬íŠ¸ ê²½ë¡œ ìˆ˜ì • (composeApp ëª¨ë“ˆ ê¸°ì¤€)
          files: composeApp/build/test-results/**/*.xml
          check_name: 'í…ŒìŠ¤íŠ¸ ê²°ê³¼ ğŸ› ï¸'
          comment_mode: 'off'