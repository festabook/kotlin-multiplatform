name: Slack Notification (Review Requested)

on:
  pull_request:
    types: [ review_requested ]

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: pr-${{ github.event.pull_request.number }}-slack-review-requested
  cancel-in-progress: true

# ì¬ë¦¬ë·° ìš”ì²­ ì•Œë¦¼
jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # JSON íŒŒì‹± ë„êµ¬
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Notify Re-review Requested
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ github.token }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_REVIEWER: ${{ github.event.requested_reviewer.login }}
          REPOSITORY: ${{ github.repository }}
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          declare -A GITHUB_TO_SLACK
          GITHUB_TO_SLACK["soeun2537"]="U09A0LM0CRW"
          GITHUB_TO_SLACK["taek2222"]="U099ARRH3D3"
          GITHUB_TO_SLACK["changuii"]="U099BR9RNE6"
          GITHUB_TO_SLACK["eoehd1ek"]="U0995NANDML"
          GITHUB_TO_SLACK["oungsi2000"]="U098U2R57NK"
          GITHUB_TO_SLACK["parkjiminnnn"]="U098U8SLXHD"
          GITHUB_TO_SLACK["etama123"]="U0995MPSZ62"
          
          if [[ "$PR_REVIEWER" == *"[bot]" ]]; then
            echo "Bot ê³„ì • ë¦¬ë·° ìš”ì²­ì€ ì•Œë¦¼ ìƒëµ"
            exit 0
          fi

          REVIEW_API_URL="https://api.github.com/repos/$REPOSITORY/pulls/$PR_NUMBER/reviews"
          REVIEW_COUNT=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "$REVIEW_API_URL" \
            | jq -r --arg reviewer "$PR_REVIEWER" '[.[] | select(.user.login == $reviewer)] | length')
          if [ "$REVIEW_COUNT" -eq 0 ]; then
            echo "ìµœì´ˆ ë¦¬ë·° ìš”ì²­ìœ¼ë¡œ ê°„ì£¼ë˜ì–´ ì•Œë¦¼ ìƒëµ"
            exit 0
          fi
          
          slack_id=${GITHUB_TO_SLACK[$PR_REVIEWER]}
          if [[ -z "$slack_id" ]]; then
            echo "ë§¤í•‘ ì—†ëŠ” ì‚¬ìš©ì(${PR_REVIEWER})ëŠ” ìƒëµ"
            exit 0
          fi
          
          if [[ -n "${GITHUB_TO_SLACK[$PR_AUTHOR]}" ]]; then
            SLACK_AUTHOR_MENTION="<@${GITHUB_TO_SLACK[$PR_AUTHOR]}>"
          else
            SLACK_AUTHOR_MENTION="@${PR_AUTHOR}"   # í‰ë¬¸
          fi

          SLACK_REVIEWER_MENTION="<@$slack_id>"
          
          PAYLOAD=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg title "$PR_TITLE" \
            --arg number "$PR_NUMBER" \
            --arg author "$SLACK_AUTHOR_MENTION" \
            --arg reviewer "$SLACK_REVIEWER_MENTION" \
            --arg url "$PR_URL" \
            '{
              text: "ğŸ¸ (\($repo)) ì¬ë¦¬ë·° ìš”ì²­ ì•Œë¦¼",
              blocks: [
                {type: "header", text: {type: "plain_text", text: "ğŸ¸ (\($repo)) ì¬ë¦¬ë·° ìš”ì²­ ì•Œë¦¼", emoji: true}},
                {type: "section", text: {type: "mrkdwn", text: "*PR ì œëª©:* \($title) (#\($number))\n*ì‘ì„±ì:* \($author)\n*ë¦¬ë·°ì–´:* \($reviewer)\n*ë§í¬:* \($url)"}}
              ]
            }')
          
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK_URL
